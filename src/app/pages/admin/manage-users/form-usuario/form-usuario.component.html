<div class="container-admin">
  <div class="header-section">
    <h2>
      <mat-icon>{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
      {{ isEditMode ? 'Editar' : 'Nuevo' }} Usuario
      <span *ngIf="isEditMode && usuarioId" class="usuario-id-badge">(ID: {{ usuarioId }})</span>
    </h2>
  </div>

  <!-- Spinner mientras carga los datos del usuario -->
  <div *ngIf="loading && isEditMode" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando datos del usuario...</p>
  </div>

  <div class="form-container" *ngIf="!loading || !isEditMode">
    <mat-card>
      <mat-card-content>
        <form [formGroup]="usuarioForm" (ngSubmit)="guardar()">
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Código *</mat-label>
              <input 
                matInput 
                formControlName="codigo"
                placeholder="Ej: DOC001, EST001, ADM001"
                maxlength="50"
              >
              <mat-icon matPrefix>badge</mat-icon>
              <mat-error *ngIf="usuarioForm.get('codigo')?.hasError('required')">
                El código es requerido
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('codigo')?.hasError('minlength')">
                Mínimo 3 caracteres
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('codigo')?.hasError('maxlength')">
                Máximo 50 caracteres
              </mat-error>
              <mat-hint>Código único del usuario (3-50 caracteres)</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Nombre Completo *</mat-label>
              <input 
                matInput 
                formControlName="nombre_completo"
                placeholder="Juan Pérez García"
              >
              <mat-icon matPrefix>person</mat-icon>
              <mat-error *ngIf="usuarioForm.get('nombre_completo')?.hasError('required')">
                El nombre es requerido
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('nombre_completo')?.hasError('minlength')">
                Mínimo 3 caracteres
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Correo Institucional *</mat-label>
              <input 
                matInput 
                type="email"
                formControlName="correo"
                placeholder="usuario@unicauca.edu.co"
              >
              <mat-icon matPrefix>email</mat-icon>
              <mat-error *ngIf="usuarioForm.get('correo')?.hasError('required')">
                El correo es requerido
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('correo')?.hasError('email') || usuarioForm.get('correo')?.hasError('pattern')">
                Debe ser un correo institucional &#64;unicauca.edu.co
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>
                Contraseña {{ isEditMode ? '(dejar vacío para no cambiar)' : '*' }}
              </mat-label>
              <input 
                matInput 
                type="password"
                formControlName="password"
                [placeholder]="isEditMode ? 'Nueva contraseña (opcional)' : 'Mínimo 6 caracteres'"
              >
              <mat-icon matPrefix>lock</mat-icon>
              <mat-error *ngIf="usuarioForm.get('password')?.hasError('required')">
                La contraseña es requerida
              </mat-error>
              <mat-error *ngIf="usuarioForm.get('password')?.hasError('minlength')">
                Mínimo 6 caracteres
              </mat-error>
              <mat-hint *ngIf="isEditMode">
                Dejar vacío para mantener la contraseña actual
              </mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Rol *</mat-label>
              <mat-select formControlName="id_rol">
                <mat-option value="">Seleccione un rol</mat-option>
                <mat-option *ngFor="let rol of roles" [value]="rol.id_rol">
                  {{ rol.nombre }}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>admin_panel_settings</mat-icon>
              <mat-error *ngIf="usuarioForm.get('id_rol')?.hasError('required')">
                El rol es requerido
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Programa Académico *</mat-label>
              <mat-select formControlName="id_programa">
                <mat-option value="">Seleccione un programa</mat-option>
                <mat-option *ngFor="let programa of programas" [value]="programa.id_programa">
                  {{ programa.nombre_programa }}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>school</mat-icon>
              <mat-error *ngIf="usuarioForm.get('id_programa')?.hasError('required')">
                El programa es requerido
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Estado *</mat-label>
              <mat-select formControlName="estado_usuario">
                <mat-option [value]="1">Activo</mat-option>
                <mat-option [value]="0">Inactivo</mat-option>
              </mat-select>
              <mat-icon matPrefix>toggle_on</mat-icon>
              <mat-error *ngIf="usuarioForm.get('estado_usuario')?.hasError('required')">
                El estado es requerido
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button 
              mat-button 
              type="button"
              (click)="cancelar()"
              [disabled]="loading"
            >
              <mat-icon>cancel</mat-icon>
              Cancelar
            </button>
            <button 
              mat-raised-button 
              color="primary"
              type="submit"
              [disabled]="loading || usuarioForm.invalid"
            >
              <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
              <mat-icon *ngIf="!loading">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
              {{ isEditMode ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>

